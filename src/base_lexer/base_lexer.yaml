states:
  - { kind: state, name: COMMAND_TEXT }
  - { kind: state, name: SUBTREE_HEAD }
  - { kind: state, name: LEAD }

  - { kind: xstate, name: COMMAND }
  - { kind: xstate, name: COMMAND_RAW }
  - { kind: xstate, name: COMMAND_EXAMPLE }
  - { kind: xstate, name: COMMAND_EXPORT }
  - { kind: xstate, name: COMMAND_SRC }
  - { kind: xstate, name: COMMAND_ARGS }
  - { kind: xstate, name: COMMAND_TBLFM }
  - { kind: xstate, name: BODY_SRC }
  - { kind: xstate, name: BODY_EXPORT }
  - { kind: xstate, name: PROPERTIES }
  - { kind: xstate, name: PROPERTY_LITERAL }

rx_macros:
  - { name: space, value: "[\\h\\xA0]" }
  - { name: lead_space, value: "^[\\h\\xA0]*"}
  # Group of built-in org-mode properties that can be statically identified
  # and lexed to corresponding tokens. All unknown properties and directives
  # will be converted to raw string literals and processed at later
  # stages, mostly in sem layer
  - { name: literal_properties, value: "id|effort" }
  - { name: argument_properties, value: "header-args" }
  - { name: text_properties, value: "description" }
  - { name: dsl_links, value: "file|attachment|id" }
  # Property colon with optional text extension pattern an any number of
  # following spaces. Used both in line command directives and subtree
  # properties
  - { name: prop_colon, value: "\\+?:[\\h\\xA0]*" }

tokens:
  - { name: "Indent" }
  - { name: "Dedent" }
  - { name: "SameIndent" }
  - { name: "ListStart" }
  - { name: "ListEnd" }
  - { name: StmtListOpen }
  - { name: StmtListClose }
  - { name: ListItemEnd }
  - { name: Unknown }

rules:
  #region Blocks
  #tag begin_quote
  - re: "begin_quote"
    states: [COMMAND]
    token: CmdQuoteBegin
    actions: [{ do: pop, to: INITIAL, from: COMMAND }]

  - re: "end_quote"
    states: [COMMAND]
    token: CmdQuoteEnd
    actions: [{ do: pop, to: INITIAL, from: COMMAND }]

  #tag begin_center
  - re: "begin_center"
    states: [COMMAND]
    token: CmdCenterBegin
    actions: [{ do: pop, to: INITIAL, from: COMMAND }]

  - re: "end_center"
    states: [COMMAND]
    token: CmdCenterEnd
    actions: [{ do: pop, to: INITIAL, from: COMMAND }]

  #region begin_example
  - re: "begin_example"
    states: [COMMAND]
    token: CmdExampleBegin
    actions: [{ do: push, from: COMMAND, to: COMMAND_EXAMPLE }]

  - re: "^{space}*#\\+end_example{space}*$"
    states: [COMMAND_EXAMPLE]
    token: CmdExampleEnd
    actions:
      - { do: pop, from: COMMAND_EXAMPLE, to: COMMAND }
      - { do: pop, from: COMMAND, to: INITIAL }

  - re: "^.*$"
    states: [COMMAND_EXAMPLE]
    token: CmdExampleLine

  - re: "\\n"
    states: [COMMAND_EXAMPLE]
    token: Newline

  #endregion

  #region begin_export
  - re: "begin_export"
    states: [COMMAND]
    token: CmdExportBegin
    actions: [{ do: push, from: COMMAND, to: COMMAND_EXPORT }]

  - re: "^{space}*#\\+end_export{space}*$"
    states: [BODY_EXPORT]
    token: CmdExportEnd
    actions:
      - { do: pop, from: BODY_EXPORT, to: INITIAL }

  - re: "^.*$"
    states: [COMMAND_EXPORT]
    token: CmdExportLine

  - re: "\\n"
    states: [COMMAND_EXPORT]
    token: Newline
    actions:
      - { do: "pop", from: COMMAND_EXPORT, to: COMMAND }
      - { do: "pop", from: COMMAND, to: INITIAL }
      - { do: "push", to: BODY_EXPORT, from: INITIAL }

  #endregion

  #region begin_src
  - re: "begin_src"
    states: [COMMAND]
    token: CmdSrcBegin
    actions: [{ do: "push", to: COMMAND_SRC, from: COMMAND }]
  - re: "^{space}*#\\+end_src{space}*$"
    states: [BODY_SRC]
    token: CmdSrcEnd
    actions:
      - { do: pop, from: BODY_SRC, to: INITIAL }

  - re: "\\n"
    states: [COMMAND_SRC]
    token: Newline
    actions:
      - { do: "pop", from: COMMAND_SRC, to: COMMAND }
      - { do: "pop", from: COMMAND, to: INITIAL }
      - { do: "push", to: BODY_SRC, from: INITIAL }
  - { lit: "<<", states: [BODY_SRC], token: SrcTangleOpen }
  - { lit: ">>", states: [BODY_SRC], token: SrcTangleClose }
  - { re: ".+", states: [BODY_SRC], token: SrcContent }
  - { re: "\\n", states: [BODY_SRC], token: Newline }
  #endregion
  #endregion

  #region Command-parameters
  - {
      re: ":\\w+",
      states: [COMMAND_ARGS, COMMAND_SRC, COMMAND_EXPORT],
      token: CmdColonIdent,
    }
  - {
      re: "\\w+",
      states: [COMMAND_ARGS, COMMAND_SRC, COMMAND_EXPORT],
      token: CmdIdent,
    }
  - {
      re: "{space}+",
      states: [COMMAND_ARGS, COMMAND_SRC, COMMAND_EXPORT],
      token: Whitespace,
    }
  - {
      re: "[\\H--[\\n]]+",
      states: [COMMAND_ARGS, COMMAND_SRC, COMMAND_EXPORT],
      token: CmdRawArg,
    }

  #endregion

  #region Line-commands
  #tag Prefix
  - re: "^#\\+"
    token: LineCommand
    actions:
      - { do: push, to: COMMAND, from: INITIAL }

  - lit: "#+"
    states: [LEAD]
    token: LineCommand
    actions:
      - { do: pop, to: INITIAL, from: LEAD }
      - { do: push, to: COMMAND, from: INITIAL }

  #region DSL-commands
  - re: "columns{prop_colon}"
    token: CmdColumns
    states: [COMMAND]
    actions:
      - { do: push, from: COMMAND, to: COMMAND_RAW }

  - re: "latex_header{prop_colon}"
    states: [COMMAND]
    token: CmdLatexHeader
    actions: [{ do: push, to: COMMAND_ARGS, from: COMMAND }]

  - re: "options{prop_colon}"
    states: [COMMAND]
    token: CmdOptions
    # Full options parsing is deferred to the sem stage
    actions: [{ do: push, to: COMMAND_RAW, from: COMMAND }]

  - re: "filetags{prop_colon}"
    states: [COMMAND]
    token: CmdFiletags
    actions: [{ do: push, to: COMMAND_RAW, from: COMMAND }]

  - re: "property{prop_colon}"
    states: [COMMAND]
    token: CmdPropertyRaw
    actions: [{ do: push, to: COMMAND_RAW, from: COMMAND }]

  - re: ".*"
    states: [COMMAND_RAW]
    token: RawText

  #region Table-command
  - re: "tblfm{prop_colon}"
    states: [COMMAND]
    token: CmdTblfm
    actions: [{ do: push, to: COMMAND_TBLFM, from: COMMAND }]
  - { re: "\\$\\d+", states: [COMMAND_TBLFM], token: TblColumnRef }
  - { re: "=", states: [COMMAND_TBLFM], token: TblAssign }
  - { re: "@-?\\d+", states: [COMMAND_TBLFM], token: TblRelativeColumnRef }
  - { re: "{space}+", states: [COMMAND_TBLFM], token: Whitespace }
  - { re: "[-]", states: [COMMAND_TBLFM], token: TblOperator }
  #endregion

  #endregion

  #region Text-commands
  - re: "caption{prop_colon}"
    states: [COMMAND]
    token: CmdCaption
    actions: [{ do: push, to: COMMAND_TEXT, from: COMMAND }]

  - re: "property{prop_colon}({text_properties})"
    states: [COMMAND]
    token: CmdPropertyText
    actions: [{ do: push, to: COMMAND_TEXT, from: COMMAND }]

  - re: "title{prop_colon}"
    states: [COMMAND]
    token: CmdTitle
    actions: [{ do: push, to: COMMAND_TEXT, from: COMMAND }]
  #endregion

  #region Argument-commands
  - re: "property{prop_colon}({argument_properties})"
    states: [COMMAND]
    token: CmdPropertyArgs
    actions: [{ do: push, to: COMMAND_ARGS, from: COMMAND }]
  #endregion

  #endregion

  #region Subtree
  - re: "^\\*+(?={space}+)"
    token: SubtreeStars
    actions:
      - { do: push, from: INITIAL, to: SUBTREE_HEAD }

  - re: "\\[#\\w\\]"
    token: SubtreePriority
    states: [SUBTREE_HEAD]

  - { re: "^[0-9]+[\\.\\)](?={space}+)", token: LeadingNumber }
  - { re: "[0-9]+", token: Number }
  - re: "^{space}+"
    token: LeadingSpace
    actions:
      - { do: push, to: LEAD, from: INITIAL }

  #region Properties
  - re: "{lead_space}:LOGBOOK:"
    token: TreePropertyLogbook
  - re: "{lead_space}:PROPERTIES:"
    token: TreePropertyProperties
  - re: "{lead_space}:END:"
    token: TreePropertyEnd
  - re: "{lead_space}:({literal_properties}):"
    token: TreePropertyLiteral
    actions:
      - { do: push, from: INITIAL, to: PROPERTY_LITERAL }

  - re: "{space}+"
    token: Whitespace
    states: [PROPERTY_LITERAL]

  - re: ".*$"
    token: RawText
    states: [PROPERTY_LITERAL]

  - re: "\\n"
    token: Newline
    states: [PROPERTIES]

  - re: "\\n"
    token: Newline
    states: [PROPERTY_LITERAL]
    actions:
      - { do: pop, from: PROPERTY_LITERAL, to: INITIAL }

  # Properties with text content
  - re: "{lead_space}:(created|origin|blocker):"
    token: TreePropertyText
  - re: "{lead_space}:\\w+:"
    token: TreePropertyName
  #endregion

  #endregion

  #region Text-elements
  #region Links and footnotes
  - { re: "{space}+", token: Whitespace }
  - { lit: "[fn:", token: FootnoteBegin }
  - { re: "\\[\\[({dsl_links}):.*?\\]\\]", token: DslLink }
  - { re: "\\[\\[({dsl_links}):.*?\\]\\[", token: DslLinkBegin }
  - { re: "\\[\\[\\w+:", token: LinkBegin }
  - { re: "\\]\\]", token: LinkEnd }
  - { re: "\\]\\[", token: LinkSplit }
  #endregion

  - { re: "\\[", token: BraceOpen }
  - { re: "\\]", token: BraceClose }
  - { re: "\\d{{4}}-\\d{{2}}-\\d{{2}}", token: Date }
  - { re: "\\d{{2}}:\\d{{2}}:\\d{{2}}", token: Time }
  - { re: "\\d{{1,}}:\\d{{2}}", token: Time }
  - { re: "=>", token: TimeArrow }
  - { re: "--", token: DoubleDash }
  - { re: "#{space}+.*?$", token: Comment }

  - { lit: "CLOCK:", token: TreeClock }

  #region Punctuation
  - { lit: "&", token: Ampersand }
  - { lit: "!", token: Exclamation }
  - { lit: "/", token: ForwardSlash }
  - { re: "[\\.?]", token: AnyPunct }
  - { re: "^\\-(?={space}+)", token: LeadingMinus }
  - { re: "^\\+(?={space}+)", token: LeadingPlus }

  - { re: "\\+", token: Plus }
  - { re: "^\\-{{5,}}", token: TextSeparator }
  - { re: "\\-", token: Minus }
  - { re: "\\\"", token: DoubleQuote }
  - { re: "\\'", token: SingleQuote }
  - { re: "\\\\\\\\", token: DoubleSlash }
  - { re: "#\\w+", token: HashIdent }
  - { re: "##", token: DoubleHash }
  - { lit: "(", token: LeftPar }
  - { lit: ")", token: RightPar }
  - { lit: "~", token: Tilda }
  - { lit: "=", token: Equals }
  - { lit: ";", token: Semicolon }
  - { lit: "*", token: Asterisk }
  - { lit: ",", token: Comma }
  - { lit: "<<", token: DoubleLeftAngle }
  - { lit: ">>", token: DoubleRightAngle }
  - { lit: "<", token: LeftAngle }
  - { lit: ">", token: RightAngle }
  - { lit: "^", token: Circumflex }
  - { lit: ":", token: Colon }
  - { lit: "{{{", token: MacroBegin }
  - { lit: "}}}", token: MacroEnd }
  - { lit: "{", token: LeftCurly }
  - { lit: "}", token: RightCurly }

  - { re: "\\\\\\w+", token: Symbol }
  - { re: "\\\\.", token: EscapedChar }
  - { lit: "%", token: Percent }
  - { re: "@\\w+", token: At }
  - { lit: "|", token: Pipe }
  - { lit: "```", token: TripleBacktick }
  - { lit: "`", token: Backtick }
  - { re: "\\p{{Punctuation}}", token: AnyPunct }
  - { re: "\\w+", token: Word }
  - { re: "\\$", token: Dollar }
  - { re: "[\\x{{0256}}-\\x{{10FFFF}}]|©", token: MiscUnicode }
  #endregion
  #endregion

  #region Newline-highlevel
  - re: "\\n"
    states: [LEAD]
    token: Newline
    actions: [{ do: pop, from: LEAD, to: INITIAL }]

  - re: "\\n{space}*\\n({space}*\\n)+"
    token: LongNewline
    states: [COMMAND_TEXT, COMMAND_RAW, COMMAND_ARGS, COMMAND_TBLFM]
    actions:
      - { do: pop, to: COMMAND }
      - { do: pop, from: COMMAND, to: INITIAL }
  - re: "\\n{space}*\\n"
    token: MediumNewline
    states: [COMMAND_TEXT, COMMAND_RAW, COMMAND_ARGS, COMMAND_TBLFM]
    actions:
      - { do: pop, to: COMMAND }
      - { do: pop, from: COMMAND, to: INITIAL }
  - re: "\\n"
    token: Newline
    states: [COMMAND_TEXT, COMMAND_RAW, COMMAND_ARGS, COMMAND_TBLFM]
    actions:
      - { do: pop, to: COMMAND }
      - { do: pop, from: COMMAND, to: INITIAL }

  - re: "\\n{space}*\\n({space}*\\n)+"
    token: LongNewline
    states: [LEAD, SUBTREE_HEAD]
    actions: [{ do: pop, to: INITIAL }]
  - re: "\\n{space}*\\n"
    token: MediumNewline
    states: [LEAD, SUBTREE_HEAD]
    actions: [{ do: pop, to: INITIAL }]
  - re: "\\n"
    token: Newline
    states: [LEAD, SUBTREE_HEAD]
    actions: [{ do: pop, to: INITIAL }]

  - re: "\\n{space}*\\n({space}*\\n)+"
    token: LongNewline
  - re: "\\n{space}*\\n"
    token: MediumNewline
  - re: "\\n"
    token: Newline
  #endregion

  - re: "<<EOF>>"
    token: EndOfFile
    states: [SUBTREE_HEAD]
    actions:
      - { do: pop, from: SUBTREE_HEAD, to: INITIAL }
      - { do: raw, raw: "return 0;" }

  - re: "<<EOF>>"
    token: "EndOfFile"
    actions: [{ do: raw, raw: "return 0;" }]
